<?php
namespace app\modules\api\controllers;

use app\modules\api\models\db\BioUser;
use app\modules\api\models\forms\RegistrationForm;
use app\modules\api\models\forms\LoginForm;
use app\modules\api\models\forms\UploadForm;
use app\modules\api\models\db\BioDoctorPacientConnection;
use yii\base\Theme;
use yii\web\UploadedFile;
use app\modules\api\models\BioFileHelper;
use Yii;

class UserController extends _ApiController
{
    public function behaviors()
    {
        $behaviors = parent::behaviors();
        $behaviors['corsFilter'] = [
            'class' => \yii\filters\Cors::className(),
            'cors' => [
                // restrict access to
                'Origin' => ['*'],
                'Access-Control-Request-Method' => ['POST', 'PUT'],
                // Allow only POST and PUT methods
                'Access-Control-Request-Headers' => ['X-Wsse'],
                // Allow only headers 'X-Wsse'
                'Access-Control-Allow-Credentials' => true,
                // Allow OPTIONS caching
                'Access-Control-Max-Age' => 3600,
                // Allow the X-Pagination-Current-Page header to be exposed to the browser.
                'Access-Control-Expose-Headers' => ['X-Pagination-Current-Page'],
            ],
        ];
        \Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;
        return $behaviors;
    }

    public function beforeAction($action)
    {
        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function actionIndex($access_token)
    {
        $user = BioUser::findByAccessToken($access_token);
        return $user;
    }

    public function actionLogin()
    {
        $model = new LoginForm();
        $model->setAttributes(Yii::$app->request->post());
        if ($model->validate()) {
            return [
                'success' => true,
                'result' => $model->getUser(),
            ];
        } else {
            return [
                'success' => false,
                'result' => $model->errors,
            ];
        }
    }


    public function actionUser()
    {
        if(!empty($this->user)){
            return [
                'success' => true,
                'result' => $this->user->getUser($this->user->username),
            ];
        } else {
            return [
                'success' => false,
            ];
        }
    }

    public function actionRegister()
    {
        $scenario = Yii::$app->request->post('type') == 'doctor' ? 'doctor' : 'pacient';
        $model = new RegistrationForm(['scenario' => $scenario]);
        $model->setAttributes(Yii::$app->request->post());
        if ($model->validate() && $model->register()) {
            return [
                'success' => true,
                'result' => $model->getUserInfo(),
            ];
        } else {
            return [
                'success' => false,
                'result' => $model->getErrors(),
            ];
        }
    }

    public function actionUpload()
    {
        if (!empty($this->user)) {
            if (Yii::$app->request->isPost) {
                $dir = BioUser::getPhotoPath($this->user->path_key);
                BioFileHelper::deleteMainSymbols($dir); // create if not exist inside
                if (copy($_FILES["file"]["tmp_name"], $dir . '/' . $_FILES["file"]["name"])) {
                    return [
                        'success' => true,
                    ];
                } else {
                    return [
                        'success' => false,
                    ];
                }
            }
        } else {
            return [
                'success' => false,
                'result' => 'User does not exist'
            ];
        }
    }

    public function actionCreateconnectionrequest()
    {
        if (!empty($this->user)) {
            $model = new BioDoctorPacientConnection();
            $model->setAttributes(Yii::$app->request->post());
            if ($model->validate()) {
                if(!in_array($this->user->id, array(Yii::$app->request->post('doctor_id'), Yii::$app->request->post('pacient_id')))){
                    return [
                        'success' => false,
                        'result' => 'You do not have permission'
                    ];
                }
                $model->save();
                return [
                    'success' => true,
                    'result' => $model->attributes
                ];
            } else {
                return [
                    'success' => false,
                    'result' => $model->getErrors(),
                ];
            }
        } else {
            return [
                'success' => false,
                'result' => 'User does not exist'
            ];
        }
    }

    public function actionDisconnectPacientFromDoctor()
    {
        if (!empty($this->user)) {
            $model = new BioDoctorPacientConnection();
            $model->setAttributes(Yii::$app->request->post());
            $result = $model->findByPacientAndDoctor();
            if ($result) {
                if(!in_array($this->user->id, array(Yii::$app->request->post('doctor_id'), Yii::$app->request->post('pacient_id')))){
                    return [
                        'success' => false,
                        'result' => 'You do not have permission'
                    ];
                }
                $result->delete();
                return [
                    'success' => true,
                ];
            } else {
                return [
                    'success' => false,
                    'result' => 'Connect does not exist'
                ];
            }
        } else {
            return [
                'success' => false,
                'result' => 'User does not exist'
            ];
        }
    }

    public function actionApproveconnection()
    {
        if (!empty($this->user)) {
            $model = new BioDoctorPacientConnection();
            $model->setAttributes(Yii::$app->request->post());
            $result = $model->findByPacientAndDoctor();
            if ($result) {
                if(!in_array($this->user->id, array(Yii::$app->request->post('doctor_id'), Yii::$app->request->post('pacient_id')))){
                    return [
                        'success' => false,
                        'result' => 'You do not have permission'
                    ];
                }
                $result->approved = 1;
                $result->save();
                return [
                    'success' => true,
                    'result' => $result->attributes
                ];
            } else {
                return [
                    'success' => false,
                    'result' => 'Connect does not exist'
                ];
            }
        } else {
            return [
                'success' => false,
                'result' => 'User does not exist'
            ];
        }
    }

    public function actionGetdoctorspacients()
    {
        if (!empty($this->user)) {
            if (!empty(Yii::$app->request->post('doctor_id'))) {
                $condition = [
                    'doctor_id' => Yii::$app->request->post('doctor_id'),
                    'enabled' => ''
                ];

                if(Yii::$app->request->post('enabled') != 'all')
                {
                    $condition['enabled'] = Yii::$app->request->post('enabled');
                } else {
                    unset($condition['enabled']);
                }

                $connectionList= BioDoctorPacientConnection::findAll($condition);
                if (!empty($connectionList)) {
                    $pacientList = [];
                    foreach ($connectionList as $connection){
                        $pacientList[$connection->pacient_id] = BioUser::getUserInfoById($connection->pacient_id);
                    }
                    return [
                        'success' => true,
                        'result' => $pacientList
                    ];
                } else {
                    return [
                        'success' => false,
                        'result' => 'doctor_id can not be blank'
                    ];
                }
            } else {
                return [
                    'success' => false,
                    'result' => 'No results'
                ];
            }
        } else {
            return [
                'success' => false,
                'result' => 'User does not exist'
            ];
        }
    }

    public function actionGetpacientdoctors()
    {
        if (!empty($this->user)) {
            if (!empty(Yii::$app->request->post('pacient_id'))) {
                $condition = [
                    'pacient_id' => Yii::$app->request->post('pacient_id'),
                    'enabled' => ''
                ];

                if(Yii::$app->request->post('enabled') != 'all')
                {
                    $condition['enabled'] = Yii::$app->request->post('enabled');
                } else {
                    unset($condition['enabled']);
                }

                $connectionList= BioDoctorPacientConnection::findAll($condition);
                if (!empty($connectionList)) {
                    $doctorList = [];
                    foreach ($connectionList as $connection){
                        $doctorList[$connection->doctor_id] = BioUser::getUserInfoById($connection->doctor_id);
                    }
                    return [
                        'success' => true,
                        'result' => $doctorList
                    ];
                } else {
                    return [
                        'success' => false,
                        'result' => 'doctor_id can not be blank'
                    ];
                }
            } else {
                return [
                    'success' => false,
                    'result' => 'No results'
                ];
            }
        } else {
            return [
                'success' => false,
                'result' => 'User does not exist'
            ];
        }
    }

    public function actionGetUserNotices()
    {

    }
}